<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Author Co-Authorship Force Layout ‚Äì Aiden Nguyen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --panel-bg: #111827;
      --accent: #38bdf8;
      --muted: #6b7280;
      --border-subtle: rgba(148, 163, 253, 0.25);
      --font: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      margin: 0;
      font-family: var(--font);
      background: radial-gradient(circle at top, #111827 0, #020817 55%, #000 100%);
      color: #e5e7eb;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 14px 24px 10px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      border-bottom: 1px solid rgba(148, 163, 253, 0.18);
      backdrop-filter: blur(16px);
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent);
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: #f9fafb;
    }

    header p {
      margin: 0;
      font-size: 11px;
      color: var(--muted);
    }

    header .meta {
      text-align: right;
      font-size: 10px;
      color: var(--muted);
    }

    #container {
      flex: 1;
      display: flex;
      gap: 14px;
      padding: 14px;
      min-height: 0;
    }

    #left-panel {
      flex: 0 0 260px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 14px;
      border-radius: 20px;
      background: var(--panel-bg);
      border: 1px solid var(--border-subtle);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
    }

    #left-panel h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 500;
      color: #e5e7eb;
    }

    .sub-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .control-group {
      margin-bottom: 8px;
    }

    .control-label {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--muted);
    }

    input[type="range"] {
      width: 100%;
      appearance: none;
      height: 4px;
      border-radius: 4px;
      background: #1f2937;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(56, 189, 248, 0.6);
    }

    #legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding-top: 4px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 9px;
      color: #9ca3af;
      background: #1e293b;
      padding: 2px 6px;
      border-radius: 8px;
    }

    .legend-swatch {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    #network-wrapper {
      flex: 1;
      position: relative;
      border-radius: 22px;
      background: radial-gradient(circle at top, rgba(31, 41, 55, 0.6), rgba(2, 6, 23, 0.98));
      border: 1px solid rgba(75, 85, 99, 0.6);
      box-shadow: 0 22px 60px rgba(15, 23, 42, 0.85);
      overflow: hidden;
    }

    #network svg {
      width: 100%;
      height: 100%;
    }

    line.link {
      stroke: rgba(148, 163, 253, 0.16);
      stroke-width: 0.6px;
    }

    circle.node {
      stroke: #020817;
      stroke-width: 0.8px;
      cursor: pointer;
      transition: opacity 0.2s ease, r 0.2s ease;
    }

    #tooltip {
      position: fixed;
      pointer-events: none;
      background: rgba(17, 24, 39, 0.96);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 10px;
      color: #e5e7eb;
      border: 1px solid rgba(75, 85, 99, 0.8);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      opacity: 0;
      transition: opacity 0.25s ease, transform 0.25s ease;
      transform: translateY(6px);
      z-index: 20;
      max-width: 260px;
    }

    #tooltip .name {
      font-weight: 600;
      color: #f9fafb;
      font-size: 11px;
      margin-bottom: 2px;
    }

    #tooltip .affiliation {
      font-size: 9px;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    #status {
      font-size: 9px;
      color: var(--muted);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Author Co-Authorship Force Layout</h1>
      <p>Colored by top affiliation countries ¬∑ Node size by degree ¬∑ Interactive forces</p>
    </div>
    <div class="meta">
      <div>Author: <strong>Aiden Nguyen</strong></div>
      <div>Data: Scopus Author Network ¬∑ Visualization: D3.js</div>
    </div>
  </header>

  <div id="container">
    <aside id="left-panel">
      <h2>Force Controls</h2>

      <div class="control-group">
        <div class="control-label"><span>Charge Strength</span><span id="chargeValue"></span></div>
        <input type="range" id="chargeSlider" min="-200" max="-20" step="5" value="-100">
      </div>

      <div class="control-group">
        <div class="control-label"><span>Collision Padding</span><span id="collideValue"></span></div>
        <input type="range" id="collideSlider" min="0" max="30" step="1" value="8">
      </div>

      <div class="control-group">
        <div class="control-label"><span>Link Strength</span><span id="linkStrengthValue"></span></div>
        <input type="range" id="linkStrengthSlider" min="0.05" max="1" step="0.05" value="0.25">
      </div>

      <div class="control-group">
        <div class="control-label"><span>Cluster Strength</span><span id="clusterValue"></span></div>
        <input type="range" id="clusterSlider" min="0" max="0.3" step="0.01" value="0.15">
      </div>

      <div class="sub-label">Hover to highlight same-affiliation authors ¬∑ Click background to close</div>

      <h2>Country Legend</h2>
      <div id="legend"></div>
      <div id="status"></div>
    </aside>

    <section id="network-wrapper">
      <div id="network"></div>
    </section>
  </div>

  <div id="tooltip"></div>

  <script>
    const csvPath = "data_scopus.csv";
    const wrapper = document.getElementById("network-wrapper");
    const width = wrapper.clientWidth || 1200;
    const height = wrapper.clientHeight || 650;

    const svg = d3.select("#network").append("svg")
      .attr("viewBox", `0 0 ${width} ${height}`)
      .attr("preserveAspectRatio", "xMidYMid meet");

    const legend = d3.select("#legend");
    const status = d3.select("#status");
    const tooltip = d3.select("#tooltip");

    const sliders = {
      charge: d3.select("#chargeSlider"),
      collide: d3.select("#collideSlider"),
      link: d3.select("#linkStrengthSlider"),
      cluster: d3.select("#clusterSlider")
    };
    const values = {
      charge: d3.select("#chargeValue"),
      collide: d3.select("#collideValue"),
      link: d3.select("#linkStrengthValue"),
      cluster: d3.select("#clusterValue")
    };
    function updateLabels() {
      values.charge.text(sliders.charge.node().value);
      values.collide.text(sliders.collide.node().value);
      values.link.text(sliders.link.node().value);
      values.cluster.text(sliders.cluster.node().value);
    }
    updateLabels();

    d3.csv(csvPath).then(data => {
      const valid = data.filter(d => d.Year && d.Authors && d["Authors with affiliations"]);

      const authorMap = new Map();
      const linkMap = new Map();

      function parseAuthors(row) {
        return (row["Authors with affiliations"] || "")
          .split(";")
          .map(s => s.trim())
          .filter(Boolean)
          .map(a => {
            const parts = a.split(",").map(p => p.trim());
            if (parts.length < 2) return null;

            let name;
            if (parts[1] && /^[A-Z]\.?([A-Z]\.)?$/.test(parts[1])) {
              name = `${parts[0]}, ${parts[1]}`;
              parts.splice(0, 2);
            } else {
              name = parts.shift();
            }

            const country = parts.at(-1);
            const affiliation = parts.slice(0, -1).join(", ");
            return { name, country, affiliation };
          })
          .filter(Boolean);
      }

      valid.forEach(row => {
        const authors = parseAuthors(row);
        if (!authors.length) return;

        const unique = Array.from(new Map(authors.map(a => [a.name, a])).values());

        unique.forEach(a => {
          if (!authorMap.has(a.name)) {
            authorMap.set(a.name, { id: a.name, name: a.name, country: a.country, affiliation: a.affiliation, papers: new Set(), degree: 0 });
          }
          authorMap.get(a.name).papers.add(row.EID || row.Title || row.Year);
        });

        for (let i = 0; i < unique.length; i++) {
          for (let j = i + 1; j < unique.length; j++) {
            const [a, b] = [unique[i].name, unique[j].name];
            const key = a < b ? `${a}|${b}` : `${b}|${a}`;
            if (!linkMap.has(key)) linkMap.set(key, { source: a, target: b, weight: 1 });
            else linkMap.get(key).weight++;
          }
        }
      });

      const nodes = Array.from(authorMap.values());
      const links = Array.from(linkMap.values());
      links.forEach(l => {
        authorMap.get(l.source).degree++;
        authorMap.get(l.target).degree++;
      });

      const connectedNodes = nodes.filter(n => n.degree > 0);
      const validIds = new Set(connectedNodes.map(n => n.id));
      const filteredLinks = links.filter(l => validIds.has(l.source) && validIds.has(l.target));

      status.text(`Loaded ${valid.length} records ¬∑ ${connectedNodes.length} authors ¬∑ ${filteredLinks.length} links`);

      const topCountries = Array.from(d3.rollup(connectedNodes, v => v.length, d => d.country))
        .sort((a, b) => d3.descending(a[1], b[1]))
        .slice(0, 10)
        .map(d => d[0]);

      const color = d3.scaleOrdinal().domain(topCountries).range(d3.schemeTableau10);
      const rScale = d3.scaleSqrt().domain(d3.extent(connectedNodes, d => d.degree)).range([3, 12]);

      legend.selectAll("*").remove();
      topCountries.forEach(c => {
        legend.append("div").attr("class", "legend-item")
          .html(`<span class="legend-swatch" style="background:${color(c)}"></span>${c}`);
      });
      legend.append("div").attr("class", "legend-item")
        .html(`<span class="legend-swatch" style="background:#A9A9A9"></span>Others`);

      const xByCountry = d3.scalePoint()
        .domain([...topCountries, "Others"])
        .range([width * 0.1, width * 0.9]);

      let chargeStrength = +sliders.charge.node().value;
      let collidePadding = +sliders.collide.node().value;
      let linkStrength = +sliders.link.node().value;
      let clusterStrength = +sliders.cluster.node().value;

      const sim = d3.forceSimulation(connectedNodes)
        .force("link", d3.forceLink(filteredLinks).id(d => d.id).distance(d => 40 - Math.min(d.weight - 1, 10)).strength(linkStrength))
        .force("charge", d3.forceManyBody().strength(chargeStrength))
        .force("collide", d3.forceCollide().radius(d => rScale(d.degree) + collidePadding))
        .force("x", d3.forceX(d => topCountries.includes(d.country) ? xByCountry(d.country) : xByCountry("Others")).strength(clusterStrength))
        .force("y", d3.forceY(height / 2).strength(0.05))
        .force("center", d3.forceCenter(width / 2, height / 2));

      const link = svg.append("g").selectAll("line")
        .data(filteredLinks)
        .join("line")
        .attr("class", "link");

      const node = svg.append("g").selectAll("circle")
        .data(connectedNodes)
        .join("circle")
        .attr("class", "node")
        .attr("r", d => rScale(d.degree))
        .attr("fill", d => topCountries.includes(d.country) ? color(d.country) : "#A9A9A9")
        .on("mouseover", (e, d) => {
          const aff = d.affiliation;
          node.style("opacity", n => n.affiliation === aff ? 1 : 0.2);
          link.style("opacity", l => (l.source.affiliation === aff && l.target.affiliation === aff) ? 0.5 : 0.05);
        })
        .on("mouseout", () => {
          node.style("opacity", 1);
          link.style("opacity", 0.16);
        })
        .on("click", (e, d) => {
          tooltip.html(`
            <div class="name">${d.name}</div>
            <div class="affiliation">${d.affiliation}</div>
            <div>Country: <strong>${d.country}</strong></div>
            <div>Co-authors: <strong>${d.degree}</strong></div>
            <div>Papers: <strong>${d.papers.size}</strong></div>
          `)
            .style("left", `${e.clientX + 12}px`)
            .style("top", `${e.clientY + 12}px`)
            .style("opacity", 1)
            .style("transform", "translateY(0px)");
        });

      // üÜï Hide tooltip only when clicking outside of nodes
      svg.on("click", (event) => {
        if (event.target.tagName !== "circle") {
          tooltip.transition().duration(200)
            .style("opacity", 0)
            .style("transform", "translateY(6px)");
        }
      });

      sim.on("tick", () => {
        link.attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
        node.attr("cx", d => d.x = Math.max(8, Math.min(width - 8, d.x)))
            .attr("cy", d => d.y = Math.max(8, Math.min(height - 8, d.y)));
      });

      for (const key of Object.keys(sliders)) {
        sliders[key].on("input", function() {
          updateLabels();
          chargeStrength = +sliders.charge.node().value;
          collidePadding = +sliders.collide.node().value;
          linkStrength = +sliders.link.node().value;
          clusterStrength = +sliders.cluster.node().value;
          sim.force("charge").strength(chargeStrength);
          sim.force("collide").radius(d => rScale(d.degree) + collidePadding);
          sim.force("link").strength(linkStrength);
          sim.force("x").strength(clusterStrength);
          sim.alpha(0.6).restart();
        });
      }
    }).catch(() => {
      status.text("‚ö†Ô∏è Error loading CSV. Ensure data_scopus.csv is in the same folder as index.html");
    });
  </script>
</body>
</html>